Vagrant.configure("2") do |config|
  config.vm.box = "debian/bullseye64"

  # Shared script to get the correct Bridge IP (ignoring NAT 10.0.2.15)
  $get_ip_script = <<-SCRIPT
    # Find the IP that is NOT 127.0.0.1 and NOT 10.0.2.15 (Vagrant NAT)
    ip -4 addr show | grep -oP '(?<=inet\\s)\\d+(\\.\\d+){3}' | grep -v '127.0.0.1' | grep -v '10.0.2.15' | head -1
  SCRIPT

  # ---------------------------------------------------------------------------
  # BACKEND MACHINE
  # ---------------------------------------------------------------------------
  config.vm.define "backend" do |back|
    back.vm.hostname = "clutchpay-backend"
    back.vm.network "public_network"
    
    back.vm.provider "virtualbox" do |vb|
      vb.name = "ClutchPay-Backend"
      vb.memory = 4096
      vb.cpus = 2
    end

    back.vm.provision "file", source: "../../installer.sh", destination: "/tmp/installer.sh"
    
    # Step 1: Save IP immediately
    back.vm.provision "shell", inline: <<-SHELL
      MY_IP=$(#{$get_ip_script})
      echo "Backend IP detected: $MY_IP"
      echo "$MY_IP" > /vagrant/.backend_ip
    SHELL
    
    # Step 2: Wait for frontend IP and install
    back.vm.provision "shell", inline: <<-SHELL
      chmod +x /tmp/installer.sh
      
      # PATCH: Make the installer prefer eth1 (bridge) IP instead of NAT IP
      sed -i '/SERVER_IP=\$(hostname -I | awk/a SERVER_IP=$(ip -4 addr show eth1 2>/dev/null | grep -oP "(?<=inet\\\\s)\\\\d+(\\\\.\\\\d+){3}" || echo $SERVER_IP)' /tmp/installer.sh
      
      # Get Bridge IP
      MY_IP=$(cat /vagrant/.backend_ip)
      echo "Backend IP: $MY_IP"
      
      if [ ! -f /vagrant/.frontend_ip ]; then
        echo "ERROR: Timeout waiting for frontend IP"
        FRONT_IP=MY_IP  # Fallback to own IP
      fi
      
      FRONT_IP=$(cat /vagrant/.frontend_ip)
      echo "Frontend IP found: $FRONT_IP"
      
      # Run backend installation
      export SERVER_IP="$MY_IP"
      echo -e "${FRONT_IP}\\n80" | sudo -E bash /tmp/installer.sh --backend-only
    SHELL
  end

  # ---------------------------------------------------------------------------
  # FRONTEND MACHINE
  # ---------------------------------------------------------------------------
  config.vm.define "frontend" do |front|
    front.vm.hostname = "clutchpay-frontend"
    front.vm.network "public_network"
    
    front.vm.provider "virtualbox" do |vb|
      vb.name = "ClutchPay-Frontend"
      vb.memory = 2048
      vb.cpus = 1
    end

    front.vm.provision "file", source: "../../installer.sh", destination: "/tmp/installer.sh"
    
    # Step 1: Save IP immediately
    front.vm.provision "shell", inline: <<-SHELL
      MY_IP=$(#{$get_ip_script})
      echo "Frontend IP detected: $MY_IP"
      echo "$MY_IP" > /vagrant/.frontend_ip
    SHELL
    
    # Step 2: Wait for backend IP and install
    front.vm.provision "shell", inline: <<-SHELL
      chmod +x /tmp/installer.sh
      
      # PATCH: Make the installer prefer eth1 (bridge) IP instead of NAT IP
      sed -i '/SERVER_IP=\$(hostname -I | awk/a SERVER_IP=$(ip -4 addr show eth1 2>/dev/null | grep -oP "(?<=inet\\\\s)\\\\d+(\\\\.\\\\d+){3}" || echo $SERVER_IP)' /tmp/installer.sh
      
      # Get Bridge IP
      MY_IP=$(cat /vagrant/.frontend_ip)
      echo "Frontend IP: $MY_IP"
      
      # Wait for Backend to save its IP
      echo "Waiting for Backend IP..."
      TIMEOUT=120
      ELAPSED=0
      while [ ! -f /vagrant/.backend_ip ] && [ $ELAPSED -lt $TIMEOUT ]; do
        sleep 2
        ELAPSED=$((ELAPSED + 2))
      done
      
      if [ ! -f /vagrant/.backend_ip ]; then
        echo "ERROR: Timeout waiting for backend IP"
        exit 1
      fi
      
      BACK_IP=$(cat /vagrant/.backend_ip)
      echo "Backend IP found: $BACK_IP"
      
      # Run frontend installation
      export SERVER_IP="$MY_IP"
      echo -e "${BACK_IP}\\n3000" | sudo -E bash /tmp/installer.sh --frontend-only
    SHELL
  end
end